import { Image, Notes, Head } from "mdx-deck";
import { CodeSurferColumns, CodeSurfer, Step } from "code-surfer";
import {
  vsDark,
  nightOwl,
} from "@code-surfer/themes";

export const theme = vsDark;

import "prismjs/components/prism-typescript"
import "prismjs/components/prism-tsx"

## Auto-generating Typescript for your content model
### A workshop by your friends at Clover

---

# My name is Rachel

Contact me with any questions on Twitter! [@RachelWebDev](https://twitter.com/RachelWebDev)

---

# Today we'll learn about...

- How to use `codegen` to generate TS definitions from your Contentful project
- How to utilize TS in conjunction with Apollo
- How to use `codegen` to improve IDE checking of graphQL

---

# Why should you use Typescript?

- ~15% of all JavaScript bugs can be detected by TypeScript*
- Static checking from inside your IDE
- Easier to refactor code without breaking it

*[Per 2017 study](http://earlbarr.com/publications/typestudy.pdf)

---

<CodeSurfer>

```bash title="Install TypeScript" subtitle="then rename js files & restart the app"
npm install --save-dev typescript @types/node @types/react @types/react-dom @types/jest

# or

yarn add -D typescript @types/node @types/react @types/react-dom @types/jest
```

</CodeSurfer>

---

<CodeSurfer>

```js title=".env" subtitle="Adding Contentful credentials"
REACT_APP_CONTENTFUL_SPACE_ID=z1e74uympjtv
REACT_APP_CONTENTFUL_ENVIRONMENT=master
REACT_APP_CONTENTFUL_API_KEY=hOSyAyj25eyBNh3tRBScPJLu40SRSx-EgjWGTdtrA98
```

</CodeSurfer>

---

<CodeSurfer>

```ts 13:24 showNumbers title="src/App.tsx" file="src/step0/App.jsx" subtitle="Our query to get all toys"
```

```ts 42:57 showNumbers title="src/App.tsx" file="src/step0/App.jsx" subtitle="Utilizing fetch to send the request then updating state"
```

```ts 27:32 showNumbers title="src/App.tsx" file="src/step0/App.jsx" subtitle="Our state initialization"
```

```ts 26:52 showNumbers title="src/App.tsx" file="src/step1/App.tsx" subtitle="Adding a custom type to define the shape of our state"
```
</CodeSurfer>

---

<CodeSurfer>

```bash title="Install graphql-codegen"
npm install --save-dev @graphql-codegen/cli graphql @graphql-codegen/typescript

# or

yarn add -D @graphql-codegen/cli graphql @graphql-codegen/typescript
```

</CodeSurfer>

---

<CodeSurfer>

```yml showNumbers title="codegen.yml" file="src/step2/codegen.yml" subtitle="Configure codegen"
```

</CodeSurfer>

---

<CodeSurfer>

```json 3 title="package.json" subtitle="Add a script to generate src/schema.ts"
{
  "scripts": {
    "gen": "graphql-codegen --config codegen.yml --require dotenv/config",
    "start": "react-scripts start",
    "build": "react-scripts build"
  }
}
```

```json 3:5 title="package.json" subtitle="Ensure this step is ran before starting the app"
{
  "scripts": {
    "gen": "graphql-codegen --config codegen.yml --require dotenv/config",
    "start": "yarn gen && react-scripts start",
    "build": "yarn gen && react-scripts build"
  }
}
```

</CodeSurfer>

---

<CodeSurfer>

```bash title="Restart the app OR run the script to generate src/schema.ts"
npm run gen

# or

yarn gen
```

</CodeSurfer>

---

<CodeSurfer>

```ts 230:248 showNumbers title="src/schema.ts" file="src/step2/schema.ts"
```

</CodeSurfer>

---

<CodeSurfer>

```ts 26:52 showNumbers title="src/App.tsx" file="src/step1/App.tsx" subtitle="Our current code"
```

```ts 2,28:42 showNumbers title="src/App.tsx" file="src/step2/App.tsx" subtitle="Import and use DogToyCollection from schema.ts"
```

```ts 28:42 showNumbers title="src/App.tsx" file="src/step2/App.tsx" subtitle="Using DogToyCollection"
```

```ts 26:52 showNumbers title="src/App.tsx" file="src/step1/App.tsx" subtitle="Before.."
```

</CodeSurfer>

---

Can we make this smarter?

---

---

What could Apollo Client give us?

- parsing of our graphQL queries
- intelligent caching
- less code - utilize the useQuery Hook

---

```bash title="Install Apollo Client"
npm install --save-dev @apollo/client

# or

yarn add -D typescript @apollo/client
```

---

<CodeSurfer>

```ts showNumbers title="src/index.tsx" file="src/step2/index.tsx" subtitle="Our current code"
```

```ts showNumbers title="src/index.tsx" file="src/step3/index.tsx" subtitle="Add and configure ApolloProvider"
```

</CodeSurfer>

---

<CodeSurfer>

```ts 35:71 showNumbers title="src/App.tsx" file="src/step2/App.tsx" subtitle="Our current code"
```

```ts 39 showNumbers title="src/App.tsx" file="src/step3/App.tsx" subtitle="Utilizing apollo client"
```

```ts 16:29 showNumbers title="src/App.tsx" file="src/step3/App.tsx" subtitle="useQuery expects a GraphQL AST"
```

```ts 18:39 showNumbers title="src/App.tsx" file="src/step3/App.tsx" subtitle="What if we want to add a graphql variable?"
```

```ts 18:47 showNumbers title="src/App.tsx" file="src/step4/App.tsx" subtitle="Declarative usage of graphql variables"
```

</CodeSurfer>

---

Let's utilize codegen to create the types for us

---

<CodeSurfer>

```bash title="Install typescript-operations plugin"
npm install --save-dev @graphql-codegen/typescript-operations

# or

yarn add -D @graphql-codegen/typescript-operations
```

</CodeSurfer>

---

<CodeSurfer>

```yml showNumbers title="codegen.yml" file="src/step2/codegen.yml" subtitle="Our current codegen configuration"
```

```yml showNumbers title="codegen.yml" file="src/step5/codegen.yml" subtitle="Add the typescript-operations plugin"
```

</CodeSurfer>

---

<CodeSurfer>

```bash title="Restart the app OR run the script to re-generate src/schema.ts"
npm run gen

# or

yarn gen
```

</CodeSurfer>

---

<CodeSurfer>

```ts 31:43 showNumbers title="src/App.tsx" file="src/step4/App.tsx" subtitle="Our current code"
```

```ts 31:32 showNumbers title="src/App.tsx" file="src/step5/App.tsx" subtitle="Utilizing the types from schema.ts"
```

</CodeSurfer>

---

We can use codegen to simplify this even more!

---

<CodeSurfer>

```bash title="Install typescript-operations plugin"
npm install --save-dev @graphql-codegen/typescript-react-apollo

# or

yarn add -D @graphql-codegen/typescript-react-apollo
```

</CodeSurfer>

---

<CodeSurfer>

```yml showNumbers title="codegen.yml" file="src/step5/codegen.yml" subtitle="Our current codegen configuration"
```

```yml showNumbers title="codegen.yml" file="src/step6/codegen.yml" subtitle="Add the typescript-react-apollo plugin"
```

</CodeSurfer>

---

<CodeSurfer>

```bash title="Restart the app OR run the script to re-generate src/schema.tsx"
npm run gen

# or

yarn gen
```

</CodeSurfer>

---

<CodeSurfer>

```ts 32 showNumbers title="src/App.tsx" file="src/step5/App.tsx" subtitle="Our current code"
```

```ts showNumbers title="src/App.tsx" file="src/step6/App.tsx" subtitle="Utilizing the types from schema.tsx"
```

</CodeSurfer>

---

What if you want to store your graphQL queries in *.graphql files?

---

<CodeSurfer>

```yml showNumbers title="codegen.yml" file="src/step6/codegen.yml" subtitle="Our current codegen configuration"
```

```yml showNumbers title="codegen.yml" file="src/step7/codegen.yml" subtitle="Configure codegen to look for graphql files"
```

</CodeSurfer>

---

<CodeSurfer>

```ts 16:30 showNumbers title="src/App.tsx" file="src/step6/App.tsx" subtitle="Our current code"
```

```ts 16 showNumbers title="src/App.tsx" file="src/step7/App.tsx" subtitle="Move the query to a new file - getToysUnderPrice.graphql"
```

</CodeSurfer>

---

What else can `codegen` do?

---
